#!/bin/sh
# Pre-commit hook para otimizar GIFs automaticamente

# Verificar se h√° GIFs staged
STAGED_GIFS=$(git diff --cached --name-only --diff-filter=ACM | grep -i "\.gif$")

if [ -z "$STAGED_GIFS" ]; then
    exit 0
fi

echo "GIFs detectados, otimizando..."

python -c "
import subprocess
import sys
from pathlib import Path

try:
    from PIL import Image
except ImportError:
    subprocess.run([sys.executable, '-m', 'pip', 'install', 'Pillow', '-q'])
    from PIL import Image

CONFIG = {'max_colors': 128, 'max_width': 800}

def get_staged_gifs():
    result = subprocess.run(['git', 'diff', '--cached', '--name-only', '--diff-filter=ACM'],
                          capture_output=True, text=True, check=True)
    return [Path(f) for f in result.stdout.strip().split('\n') if f.lower().endswith('.gif')]

def resize_frame(frame, max_width):
    if frame.width <= max_width:
        return frame
    ratio = max_width / frame.width
    return frame.resize((max_width, int(frame.height * ratio)), Image.Resampling.LANCZOS)

def optimize_gif(gif_path):
    if not gif_path.exists():
        return False, 0, 0
    original_size = gif_path.stat().st_size
    try:
        with Image.open(gif_path) as img:
            if img.format != 'GIF':
                return False, 0, 0
            frames, durations = [], []
            try:
                while True:
                    frame = img.copy()
                    if CONFIG['max_width']:
                        frame = resize_frame(frame, CONFIG['max_width'])
                    frames.append(frame)
                    durations.append(img.info.get('duration', 100))
                    img.seek(img.tell() + 1)
            except EOFError:
                pass
            if len(frames) < 2:
                return False, 0, 0
            if CONFIG['max_colors'] < 256:
                frames = [f.convert('RGBA').convert('P', palette=Image.Palette.ADAPTIVE, colors=CONFIG['max_colors']) if f.mode != 'P' else f for f in frames]
            frames[0].save(gif_path, save_all=True, append_images=frames[1:], duration=durations, loop=0, disposal=2, optimize=True)
            return True, original_size, gif_path.stat().st_size
    except Exception as e:
        print(f'Erro: {e}')
        return False, 0, 0

def format_size(b):
    return f'{b/1024:.1f} KB' if b < 1024*1024 else f'{b/(1024*1024):.1f} MB'

for gif in get_staged_gifs():
    ok, orig, final = optimize_gif(gif)
    if ok:
        red = ((orig - final) / orig * 100) if orig > 0 else 0
        print(f'  OK {gif.name}: {format_size(orig)} -> {format_size(final)} (-{red:.0f}%)')
        subprocess.run(['git', 'add', str(gif)], check=True)
"

if [ $? -ne 0 ]; then
    echo "Erro ao otimizar GIFs"
    exit 1
fi

exit 0
